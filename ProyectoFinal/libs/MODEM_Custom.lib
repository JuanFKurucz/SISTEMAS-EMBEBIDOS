/*** BeginHeader */

void * mensajeMailBox[1];
OS_EVENT * mailBoxMensajeMuerteModem;

/*** EndHeader */

/*** BeginHeader MODEM_init */
void MODEM_init();
/*** EndHeader */
void MODEM_init(){
	mailBoxMensajeMuerteModem = OSQCreate(&mensajeMailBox,1);
}

/*** BeginHeader MODEM_main */
void MODEM_main(void *data);
/*** EndHeader */
//Funcion que contiene diferentes tareas del modem
void MODEM_main(void *data){
	char texto[10];
	int status;
	char received[50];
	int h;
	void* punteroMensaje;
	INT8U timeout;
	INT8U err;
	h=0;
	while(1)
	{
		printf("Task debugg: MODEM_main start\n");
		status = IO_getInput(PORT_E, BIT_1);
		//printf("Status: %d\n",status);
		while(!status)
		{
			//printf("Entre\n");
			BitWrPortI(PEDDR,&PEDDRShadow,OUTPUT_DIR,BIT_4);
			BitWrPortI(PEDR,&PEDRShadow,0,BIT_4);
			OSTimeDlySec(2);
			BitWrPortI(PEDDR,&PEDDRShadow,INPUT_DIR,BIT_4);
			status = IO_getInput(PORT_E, BIT_1);
			//printf("Status: %d\n",status);
			if (status ) LED_SET(BIT_7);
			else LED_RESET(BIT_7);
		}
		MODEM_comunicarse("A");
		OSTimeDlyHMSM(0,0,5,0);
		MODEM_comunicarse("AT");
		OSTimeDlyHMSM(0,0,0,100);
		while( !serDrdUsed() )
		{
			OSTimeDlyHMSM(0,0,0,100);
		}
		timeout = 100;
		printf("Comprobando cola\n");
		punteroMensaje = OSQPend(mailBoxMensajeMuerteModem, timeout,&err);
		if(punteroMensaje != (void *)0){
			printf("%s\n",punteroMensaje);
		}
		IO_leerPuertoD(received);
		/*
		if (MODEM_ponerPin(received) == 1){
		OSTimeDlyHMSM(0,0,0,100);
		if(MODEM_registrarRed(received)==1){
		OSTimeDlyHMSM(0,0,0,100);
		if(MODEM_modoTexto(received)==1){
		OSTimeDlyHMSM(0,0,0,100);
		if(MODEM_borrarMensajes(received)==1){
		OSTimeDlyHMSM(0,0,0,100);
		//        	MODEM_enviarMensajes(received);
	}
}
}
} */
	//printf("Task debugg: MODEM_main end\n");
	}
}



/*** BeginHeader MODEM_comunicarse */
void MODEM_comunicarse(char * texto);
/*** EndHeader */
//Funcion que se comunica con el modem
void MODEM_comunicarse(char * texto){
	//printf("Comunicando: %s\n",texto);
	serDputs(texto);
	serDputc('\r');
}


/*** BeginHeader MODEM_modoTexto */
int MODEM_modoTexto(char* received);
/*** EndHeader */
//Funcion que habilita el modo texto para luego poder enviar mensajes
int MODEM_modoTexto(char* received){
	//printf("Poner modo texto\n");
	MODEM_comunicarse("AT+CMGF=1");
	memset(received, 0, sizeof(received));
	IO_leerPuertoD(received);
	//printf("%s", received);
	if(UT_isEqual(received,"OK") == 1){
		return 1;
	}
	return 0;
}

/*** BeginHeader MODEM_leerMensajes */
int MODEM_leerMensajes(char* received);
/*** EndHeader */
//Funcion que lee los mensajes recibidos
int MODEM_leerMensajes(char * received){
	//printf("Leer mensajes");
	MODEM_comunicarse("AT+CMGL=\"ALL\"");
	memset(received, 0, sizeof(received));
	IO_leerPuertoD(received);
	//printf("%s", received);
	OSTimeDlyHMSM(0,0,0,500);

	if(UT_isEqual(received,"OK") == 1){
		//MODEM_borrarMensajes(received);
		return 1;
	}
	return 0;
}


/*** BeginHeader MODEM_enviarMensajes */
int MODEM_enviarMensajes(char* received);
/*** EndHeader */
//Funcion que envia Mensajes de texto
int MODEM_enviarMensajes(char* received){
	char buffer[255];
	if(MODEM_modoTexto(received) == 1){
		//printf("Mandando un mensaje");
		memset(received, 0, sizeof(received));
		serDputs("AT+CMGS=\"091829233\"\r");
		while(!serDrdUsed());
		memset(received, 0, sizeof(received));
		IO_leerPuertoD(received);
		while (UT_isEqual(received,">") != 1)
		{
			memset(received, 0, sizeof(received));
			IO_leerPuertoD(received);
		}
		serDputc(0x0D);
		serDputs("Hellowda");
		serDputc(0x1A);
		serDputs("\r");
		memset(received, 0, sizeof(received));
		IO_leerPuertoD(received);
		while(UT_isEqual(received,"OK") != 1){
			memset(received, 0, sizeof(received));
			IO_leerPuertoD(received);
		}
		//printf("Enviado\n");
	}
}


/*** BeginHeader MODEM_borrarMensajes */
int MODEM_borrarMensajes(char* received);
/*** EndHeader */
//Funcion que borra los mensajes del celular
//Forma de liberar la bandeja de entrada
int MODEM_borrarMensajes(char * received){
	//printf("Borrar mensajes");
	MODEM_comunicarse("AT+CMGDA=\"DEL ALL\"");
	memset(received, 0, sizeof(received));
	IO_leerPuertoD(received);
	//printf("%s", received);
	if(UT_isEqual(received,"OK") == 1){
		return 1;
	}
	return 0;
}

/*** BeginHeader MODEM_ponerPin */
int MODEM_ponerPin(char* received);
/*** EndHeader */
//Funcion que ingresa el pin al chip
//Nuestro pin es 5454
int MODEM_ponerPin(char* received){
	//printf("Poner Pin");
	MODEM_comunicarse("AT+CPIN?");
	IO_leerPuertoD(received);
	//printf("\nLectura: %s\n", received);
	if(UT_isEqual(received,"SIM PIN") == 1){
		//printf("Ingresando pin\n");
		MODEM_comunicarse("AT+CPIN=5454");
		IO_leerPuertoD(received);
		//printf("%s", received);
		if(UT_isEqual(received,"OK") == 1){
			//printf("Pin ingresado correctamente");
			return 1;
		}
	}
	else if(UT_isEqual(received,"OK") == 1){
		//printf("El pin ya esta ingresado");
		return 1;
	} else {
		//printf("Caso no definifido\n");
	}
	return 0;
}


/*** BeginHeader MODEM_registrarRed */
int MODEM_registrarRed(char* received);
/*** EndHeader */
//Funcion que registra el chip en la red
//En nuestro caso el registro es para Antel
int MODEM_registrarRed(char* received){
	MODEM_comunicarse("AT+CREG?");
	memset(received, 0, sizeof(received));
	IO_leerPuertoD(received);
	if(UT_isEqual(received,"0,1") == 1){
		//printf("Esta registrado en la red Antel");
		return 1;
	}
	else{
		//Registro para Antel: "AT+COPS=1,2,\"74801\"\r"
		MODEM_comunicarse("AT+COPS=1,2,\"74801\"");
		OSTimeDlySec(1);
		return MODEM_registrarRed(received);
		//printf("Se registro en la red Antel");
	}
	return 0;
}


/*** BeginHeader MODEM_prender */
void MODEM_prender();
/*** EndHeader */
//Funcion que prende el Modem
void MODEM_prender(){
	if (!BitRdPortI(PBDR, 7)){
		BitWrPortI(PEDDR,&PEDDRShadow,0,4);
		OSTimeDlyHMSM(0,0,0,50);
		BitWrPortI(PEDDR,&PEDDRShadow,1,4);
		BitWrPortI(PEDR,&PEDRShadow,0,4);
		OSTimeDlyHMSM(0,0,2,0);
		BitWrPortI(PEDDR,&PEDDRShadow,0,4);
	}
	BitWrPortI(PEDR,&PEDRShadow, BitRdPortI(PBDR, 7), 0);
}
